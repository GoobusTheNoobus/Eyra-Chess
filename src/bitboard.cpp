#include "bitboard.hpp"

#include <iostream>

using namespace Eyra;


namespace {




// Forward Declare functions
int HashBishop (Square square, Bitboard blockers);
int HashRook   (Square square, Bitboard blockers);

Bitboard RaycastBishop (Square square, Bitboard blockers);
Bitboard RaycastRook   (Square square, Bitboard blockers);

Bitboard GenerateBlocker (int index, Bitboard mask);

void PrecomputeBishop (Square square);
void PrecomputeRook   (Square square);

// Attack Tables

Bitboard ComputeRookMask(Square square) {
    Bitboard mask = 0ULL;
    int rank = square >> 3;
    int file = square & 7;

    // North - exclude rank 8
    for (int r = rank + 1; r <= 6; r++) mask |= 1ULL << (r << 3 | file);
    // South - exclude rank 1
    for (int r = rank - 1; r >= 1; r--) mask |= 1ULL << (r << 3 | file);
    // East - exclude file H
    for (int f = file + 1; f <= 6; f++) mask |= 1ULL << (rank << 3 | f);
    // West - exclude file A
    for (int f = file - 1; f >= 1; f--) mask |= 1ULL << (rank << 3 | f);

    return mask;
}

Bitboard ComputeBishopMask(Square square) {
    Bitboard mask = 0ULL;
    int rank = square >> 3;
    int file = square & 7;

    for (int r = rank+1, f = file+1; r <= 6 && f <= 6; r++, f++) mask |= 1ULL << (r<<3|f);
    for (int r = rank+1, f = file-1; r <= 6 && f >= 1; r++, f--) mask |= 1ULL << (r<<3|f);
    for (int r = rank-1, f = file+1; r >= 1 && f <= 6; r--, f++) mask |= 1ULL << (r<<3|f);
    for (int r = rank-1, f = file-1; r >= 1 && f >= 1; r--, f--) mask |= 1ULL << (r<<3|f);

    return mask;
}

constexpr Bitboard knight_table[64] = {
    0x0000000000020400ULL, 0x0000000000050800ULL, 0x00000000000A1100ULL, 0x0000000000142200ULL,
    0x0000000000284400ULL, 0x0000000000508800ULL, 0x0000000000A01000ULL, 0x0000000000402000ULL,
    0x0000000002040004ULL, 0x0000000005080008ULL, 0x000000000A110011ULL, 0x0000000014220022ULL,
    0x0000000028440044ULL, 0x0000000050880088ULL, 0x00000000A0100010ULL, 0x0000000040200020ULL,
    0x0000000204000402ULL, 0x0000000508000805ULL, 0x0000000A1100110AULL, 0x0000001422002214ULL,
    0x0000002844004428ULL, 0x0000005088008850ULL, 0x000000A0100010A0ULL, 0x0000004020002040ULL,
    0x0000020400040200ULL, 0x0000050800080500ULL, 0x00000A1100110A00ULL, 0x0000142200221400ULL,
    0x0000284400442800ULL, 0x0000508800885000ULL, 0x0000A0100010A000ULL, 0x0000402000204000ULL,
    0x0002040004020000ULL, 0x0005080008050000ULL, 0x000A1100110A0000ULL, 0x0014220022140000ULL,
    0x0028440044280000ULL, 0x0050880088500000ULL, 0x00A0100010A00000ULL, 0x0040200020400000ULL,
    0x0204000402000000ULL, 0x0508000805000000ULL, 0x0A1100110A000000ULL, 0x1422002214000000ULL,
    0x2844004428000000ULL, 0x5088008850000000ULL, 0xA0100010A0000000ULL, 0x4020002040000000ULL,
    0x0400040200000000ULL, 0x0800080500000000ULL, 0x1100110A00000000ULL, 0x2200221400000000ULL,
    0x4400442800000000ULL, 0x8800885000000000ULL, 0x100010A000000000ULL, 0x2000204000000000ULL,
    0x0004020000000000ULL, 0x0008050000000000ULL, 0x00110A0000000000ULL, 0x0022140000000000ULL,
    0x0044280000000000ULL, 0x0088500000000000ULL, 0x0010A00000000000ULL, 0x0020400000000000ULL,
};

constexpr Bitboard king_table[64] = {
    0x0000000000000302ULL, 0x0000000000000705ULL, 0x0000000000000E0AULL, 0x0000000000001C14ULL,
    0x0000000000003828ULL, 0x0000000000007050ULL, 0x000000000000E0A0ULL, 0x000000000000C040ULL,
    0x0000000000030203ULL, 0x0000000000070507ULL, 0x00000000000E0A0EULL, 0x00000000001C141CULL,
    0x0000000000382838ULL, 0x0000000000705070ULL, 0x0000000000E0A0E0ULL, 0x0000000000C040C0ULL,
    0x0000000003020300ULL, 0x0000000007050700ULL, 0x000000000E0A0E00ULL, 0x000000001C141C00ULL,
    0x0000000038283800ULL, 0x0000000070507000ULL, 0x00000000E0A0E000ULL, 0x00000000C040C000ULL,
    0x0000000302030000ULL, 0x0000000705070000ULL, 0x0000000E0A0E0000ULL, 0x0000001C141C0000ULL,
    0x0000003828380000ULL, 0x0000007050700000ULL, 0x000000E0A0E00000ULL, 0x000000C040C00000ULL,
    0x0000030203000000ULL, 0x0000070507000000ULL, 0x00000E0A0E000000ULL, 0x00001C141C000000ULL,
    0x0000382838000000ULL, 0x0000705070000000ULL, 0x0000E0A0E0000000ULL, 0x0000C040C0000000ULL,
    0x0003020300000000ULL, 0x0007050700000000ULL, 0x000E0A0E00000000ULL, 0x001C141C00000000ULL,
    0x0038283800000000ULL, 0x0070507000000000ULL, 0x00E0A0E000000000ULL, 0x00C040C000000000ULL,
    0x0302030000000000ULL, 0x0705070000000000ULL, 0x0E0A0E0000000000ULL, 0x1C141C0000000000ULL,
    0x3828380000000000ULL, 0x7050700000000000ULL, 0xE0A0E00000000000ULL, 0xC040C00000000000ULL,
    0x0203000000000000ULL, 0x0507000000000000ULL, 0x0A0E000000000000ULL, 0x141C000000000000ULL,
    0x2838000000000000ULL, 0x5070000000000000ULL, 0xA0E0000000000000ULL, 0x40C0000000000000ULL,
};

constexpr Bitboard pawn_table[2][64] = {
    {
    0x0000000000000200ULL, 0x0000000000000500ULL, 0x0000000000000A00ULL, 0x0000000000001400ULL,
    0x0000000000002800ULL, 0x0000000000005000ULL, 0x000000000000A000ULL, 0x0000000000004000ULL,
    0x0000000000020000ULL, 0x0000000000050000ULL, 0x00000000000A0000ULL, 0x0000000000140000ULL,
    0x0000000000280000ULL, 0x0000000000500000ULL, 0x0000000000A00000ULL, 0x0000000000400000ULL,
    0x0000000002000000ULL, 0x0000000005000000ULL, 0x000000000A000000ULL, 0x0000000014000000ULL,
    0x0000000028000000ULL, 0x0000000050000000ULL, 0x00000000A0000000ULL, 0x0000000040000000ULL,
    0x0000000200000000ULL, 0x0000000500000000ULL, 0x0000000A00000000ULL, 0x0000001400000000ULL,
    0x0000002800000000ULL, 0x0000005000000000ULL, 0x000000A000000000ULL, 0x0000004000000000ULL,
    0x0000020000000000ULL, 0x0000050000000000ULL, 0x00000A0000000000ULL, 0x0000140000000000ULL,
    0x0000280000000000ULL, 0x0000500000000000ULL, 0x0000A00000000000ULL, 0x0000400000000000ULL,
    0x0002000000000000ULL, 0x0005000000000000ULL, 0x000A000000000000ULL, 0x0014000000000000ULL,
    0x0028000000000000ULL, 0x0050000000000000ULL, 0x00A0000000000000ULL, 0x0040000000000000ULL,
    0x0200000000000000ULL, 0x0500000000000000ULL, 0x0A00000000000000ULL, 0x1400000000000000ULL,
    0x2800000000000000ULL, 0x5000000000000000ULL, 0xA000000000000000ULL, 0x4000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    },
    {
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000002ULL, 0x0000000000000005ULL, 0x000000000000000AULL, 0x0000000000000014ULL,
    0x0000000000000028ULL, 0x0000000000000050ULL, 0x00000000000000A0ULL, 0x0000000000000040ULL,
    0x0000000000000200ULL, 0x0000000000000500ULL, 0x0000000000000A00ULL, 0x0000000000001400ULL,
    0x0000000000002800ULL, 0x0000000000005000ULL, 0x000000000000A000ULL, 0x0000000000004000ULL,
    0x0000000000020000ULL, 0x0000000000050000ULL, 0x00000000000A0000ULL, 0x0000000000140000ULL,
    0x0000000000280000ULL, 0x0000000000500000ULL, 0x0000000000A00000ULL, 0x0000000000400000ULL,
    0x0000000002000000ULL, 0x0000000005000000ULL, 0x000000000A000000ULL, 0x0000000014000000ULL,
    0x0000000028000000ULL, 0x0000000050000000ULL, 0x00000000A0000000ULL, 0x0000000040000000ULL,
    0x0000000200000000ULL, 0x0000000500000000ULL, 0x0000000A00000000ULL, 0x0000001400000000ULL,
    0x0000002800000000ULL, 0x0000005000000000ULL, 0x000000A000000000ULL, 0x0000004000000000ULL,
    0x0000020000000000ULL, 0x0000050000000000ULL, 0x00000A0000000000ULL, 0x0000140000000000ULL,
    0x0000280000000000ULL, 0x0000500000000000ULL, 0x0000A00000000000ULL, 0x0000400000000000ULL,
    0x0002000000000000ULL, 0x0005000000000000ULL, 0x000A000000000000ULL, 0x0014000000000000ULL,
    0x0028000000000000ULL, 0x0050000000000000ULL, 0x00A0000000000000ULL, 0x0040000000000000ULL,
    }
};

/*constexpr Bitboard wpawn_table[64] = {
    0x0000000000000200ULL, 0x0000000000000500ULL, 0x0000000000000A00ULL, 0x0000000000001400ULL,
    0x0000000000002800ULL, 0x0000000000005000ULL, 0x000000000000A000ULL, 0x0000000000004000ULL,
    0x0000000000020000ULL, 0x0000000000050000ULL, 0x00000000000A0000ULL, 0x0000000000140000ULL,
    0x0000000000280000ULL, 0x0000000000500000ULL, 0x0000000000A00000ULL, 0x0000000000400000ULL,
    0x0000000002000000ULL, 0x0000000005000000ULL, 0x000000000A000000ULL, 0x0000000014000000ULL,
    0x0000000028000000ULL, 0x0000000050000000ULL, 0x00000000A0000000ULL, 0x0000000040000000ULL,
    0x0000000200000000ULL, 0x0000000500000000ULL, 0x0000000A00000000ULL, 0x0000001400000000ULL,
    0x0000002800000000ULL, 0x0000005000000000ULL, 0x000000A000000000ULL, 0x0000004000000000ULL,
    0x0000020000000000ULL, 0x0000050000000000ULL, 0x00000A0000000000ULL, 0x0000140000000000ULL,
    0x0000280000000000ULL, 0x0000500000000000ULL, 0x0000A00000000000ULL, 0x0000400000000000ULL,
    0x0002000000000000ULL, 0x0005000000000000ULL, 0x000A000000000000ULL, 0x0014000000000000ULL,
    0x0028000000000000ULL, 0x0050000000000000ULL, 0x00A0000000000000ULL, 0x0040000000000000ULL,
    0x0200000000000000ULL, 0x0500000000000000ULL, 0x0A00000000000000ULL, 0x1400000000000000ULL,
    0x2800000000000000ULL, 0x5000000000000000ULL, 0xA000000000000000ULL, 0x4000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
};

constexpr Bitboard bpawn_table[64] = {
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL, 0x0000000000000000ULL,
    0x0000000000000002ULL, 0x0000000000000005ULL, 0x000000000000000AULL, 0x0000000000000014ULL,
    0x0000000000000028ULL, 0x0000000000000050ULL, 0x00000000000000A0ULL, 0x0000000000000040ULL,
    0x0000000000000200ULL, 0x0000000000000500ULL, 0x0000000000000A00ULL, 0x0000000000001400ULL,
    0x0000000000002800ULL, 0x0000000000005000ULL, 0x000000000000A000ULL, 0x0000000000004000ULL,
    0x0000000000020000ULL, 0x0000000000050000ULL, 0x00000000000A0000ULL, 0x0000000000140000ULL,
    0x0000000000280000ULL, 0x0000000000500000ULL, 0x0000000000A00000ULL, 0x0000000000400000ULL,
    0x0000000002000000ULL, 0x0000000005000000ULL, 0x000000000A000000ULL, 0x0000000014000000ULL,
    0x0000000028000000ULL, 0x0000000050000000ULL, 0x00000000A0000000ULL, 0x0000000040000000ULL,
    0x0000000200000000ULL, 0x0000000500000000ULL, 0x0000000A00000000ULL, 0x0000001400000000ULL,
    0x0000002800000000ULL, 0x0000005000000000ULL, 0x000000A000000000ULL, 0x0000004000000000ULL,
    0x0000020000000000ULL, 0x0000050000000000ULL, 0x00000A0000000000ULL, 0x0000140000000000ULL,
    0x0000280000000000ULL, 0x0000500000000000ULL, 0x0000A00000000000ULL, 0x0000400000000000ULL,
    0x0002000000000000ULL, 0x0005000000000000ULL, 0x000A000000000000ULL, 0x0014000000000000ULL,
    0x0028000000000000ULL, 0x0050000000000000ULL, 0x00A0000000000000ULL, 0x0040000000000000ULL,
};*/

// Slider Masks and stuff

constexpr Bitboard bishop_mask[64] = {
    0x0040201008040200ULL, 0x0000402010080400ULL, 0x0000004020100A00ULL, 0x0000000040221400ULL,
    0x0000000002442800ULL, 0x0000000204085000ULL, 0x0000020408102000ULL, 0x0002040810204000ULL,
    0x0020100804020000ULL, 0x0040201008040000ULL, 0x00004020100A0000ULL, 0x0000004022140000ULL,
    0x0000000244280000ULL, 0x0000020408500000ULL, 0x0002040810200000ULL, 0x0004081020400000ULL,
    0x0010080402000200ULL, 0x0020100804000400ULL, 0x004020100A000A00ULL, 0x0000402214001400ULL,
    0x0000024428002800ULL, 0x0002040850005000ULL, 0x0004081020002000ULL, 0x0008102040004000ULL,
    0x0008040200020400ULL, 0x0010080400040800ULL, 0x0020100A000A1000ULL, 0x0040221400142200ULL,
    0x0002442800284400ULL, 0x0004085000500800ULL, 0x0008102000201000ULL, 0x0010204000402000ULL,
    0x0004020002040800ULL, 0x0008040004081000ULL, 0x00100A000A102000ULL, 0x0022140014224000ULL,
    0x0044280028440200ULL, 0x0008500050080400ULL, 0x0010200020100800ULL, 0x0020400040201000ULL,
    0x0002000204081000ULL, 0x0004000408102000ULL, 0x000A000A10204000ULL, 0x0014001422400000ULL,
    0x0028002844020000ULL, 0x0050005008040200ULL, 0x0020002010080400ULL, 0x0040004020100800ULL,
    0x0000020408102000ULL, 0x0000040810204000ULL, 0x00000A1020400000ULL, 0x0000142240000000ULL,
    0x0000284402000000ULL, 0x0000500804020000ULL, 0x0000201008040200ULL, 0x0000402010080400ULL,
    0x0002040810204000ULL, 0x0004081020400000ULL, 0x000A102040000000ULL, 0x0014224000000000ULL,
    0x0028440200000000ULL, 0x0050080402000000ULL, 0x0020100804020000ULL, 0x0040201008040200ULL,
    
};

constexpr Bitboard rook_mask[64] = {
    0x000101010101017EULL,0x000202020202027CULL,0x000404040404047AULL,0x0008080808080876ULL,
    0x001010101010106EULL,0x002020202020205EULL,0x004040404040403EULL,0x008080808080807EULL,
    0x0001010101017E00ULL,0x0002020202027C00ULL,0x0004040404047A00ULL,0x0008080808087600ULL,
    0x0010101010106E00ULL,0x0020202020205E00ULL,0x0040404040403E00ULL,0x0080808080807E00ULL,
    0x00010101017E0100ULL,0x00020202027C0200ULL,0x00040404047A0400ULL,0x0008080808760800ULL,
    0x00101010106E1000ULL,0x00202020205E2000ULL,0x00404040403E4000ULL,0x00808080807E8000ULL,
    0x000101017E010100ULL,0x000202027C020200ULL,0x000404047A040400ULL,0x0008080876080800ULL,
    0x001010106E101000ULL,0x002020205E202000ULL,0x004040403E404000ULL,0x008080807E808000ULL,
    0x0001017E01010100ULL,0x0002027C02020200ULL,0x0004047A04040400ULL,0x0008087608080800ULL,
    0x0010106E10101000ULL,0x0020205E20202000ULL,0x0040403E40404000ULL,0x0080807E80808000ULL,
    0x00017E0101010100ULL,0x00027C0202020200ULL,0x00047A0404040400ULL,0x0008760808080800ULL,
    0x00106E1010101000ULL,0x00205E2020202000ULL,0x00403E4040404000ULL,0x00807E8080808000ULL,
    0x007E010101010100ULL,0x007C020202020200ULL,0x007A040404040400ULL,0x0076080808080800ULL,
    0x006E101010101000ULL,0x005E202020202000ULL,0x003E404040404000ULL,0x007E808080808000ULL,
    0x7E01010101010100ULL,0x7C02020202020200ULL,0x7A04040404040400ULL,0x7608080808080800ULL,
    0x6E10101010101000ULL,0x5E20202020202000ULL,0x3E40404040404000ULL,0x7E80808080808000ULL,
};

constexpr uint8_t bishop_relevancy[64] = {
    6, 5, 5, 5, 5, 5, 5, 6,
    5, 5, 5, 5, 5, 5, 5, 5,
    5, 5, 7, 7, 7, 7, 5, 5,
    5, 5, 7, 9, 9, 7, 5, 5,
    5, 5, 7, 9, 9, 7, 5, 5,
    5, 5, 7, 7, 7, 7, 5, 5,
    5, 5, 5, 5, 5, 5, 5, 5,
    6, 5, 5, 5, 5, 5, 5, 6,
};

constexpr uint8_t rook_relevancy[64] = {
    12, 11, 11, 11, 11, 11, 11, 12,
    11, 10, 10, 10, 10, 10, 10, 11,
    11, 10, 10, 10, 10, 10, 10, 11,
    11, 10, 10, 10, 10, 10, 10, 11,
    11, 10, 10, 10, 10, 10, 10, 11,
    11, 10, 10, 10, 10, 10, 10, 11,
    11, 10, 10, 10, 10, 10, 10, 11,
    12, 11, 11, 11, 11, 11, 11, 12,
};

// Magic Numbers

constexpr Bitboard rook_magic[64] = {
    0x0A8002C000108020ULL, 0x06C00049B0002001ULL, 0x0100200010090040ULL, 0x2480041000800801ULL,
    0x0280028004000800ULL, 0x0900410008040022ULL, 0x0280020001001080ULL, 0x2880002041000080ULL,
    0xA000800080400034ULL, 0x0004808020004000ULL, 0x2290802004801000ULL, 0x0411000D00100020ULL,
    0x0402800800040080ULL, 0x000B000401004208ULL, 0x2409000100040200ULL, 0x0001002100004082ULL,
    0x0022878001E24000ULL, 0x1090810021004010ULL, 0x0801030040200012ULL, 0x0500808008001000ULL,
    0x0A08018014000880ULL, 0x8000808004000200ULL, 0x0201008080010200ULL, 0x0801020000441091ULL,
    0x0000800080204005ULL, 0x1040200040100048ULL, 0x0000120200402082ULL, 0x0D14880480100080ULL,
    0x0012040280080080ULL, 0x0100040080020080ULL, 0x9020010080800200ULL, 0x0813241200148449ULL,
    0x0491604001800080ULL, 0x0100401000402001ULL, 0x4820010021001040ULL, 0x0400402202000812ULL,
    0x0209009005000802ULL, 0x0810800601800400ULL, 0x4301083214000150ULL, 0x204026458E001401ULL,
    0x0040204000808000ULL, 0x8001008040010020ULL, 0x8410820820420010ULL, 0x1003001000090020ULL,
    0x0804040008008080ULL, 0x0012000810020004ULL, 0x1000100200040208ULL, 0x430000A044020001ULL,
    0x0280009023410300ULL, 0x00E0100040002240ULL, 0x0000200100401700ULL, 0x2244100408008080ULL,
    0x0008000400801980ULL, 0x0002000810040200ULL, 0x8010100228810400ULL, 0x2000009044210200ULL,
    0x4080008040102101ULL, 0x0040002080411D01ULL, 0x2005524060000901ULL, 0x0502001008400422ULL,
    0x489A000810200402ULL, 0x0001004400080A13ULL, 0x4000011008020084ULL, 0x0026002114058042ULL,
};

constexpr Bitboard bishop_magic[64] = {
    0x89A1121896040240ULL, 0x2004844802002010ULL, 0x2068080051921000ULL, 0x62880A0220200808ULL,
    0x0004042004000000ULL, 0x0100822020200011ULL, 0xC00444222012000AULL, 0x0028808801216001ULL,
    0x0400492088408100ULL, 0x0201C401040C0084ULL, 0x0840800910A00010ULL, 0x0000082080240060ULL,
    0x2000840504006000ULL, 0x30010C4108405004ULL, 0x1008005410080802ULL, 0x8144042209100900ULL,
    0x0208081020014400ULL, 0x004800201208CA00ULL, 0x0F18140408012008ULL, 0x1004002802102001ULL,
    0x0841000820080811ULL, 0x0040200200A42008ULL, 0x0000800054042000ULL, 0x88010400410C9000ULL,
    0x0520040470104290ULL, 0x1004040051500081ULL, 0x2002081833080021ULL, 0x0000400C00C010142ULL,
    0x941408200C002000ULL, 0x0658810000806011ULL, 0x0188071040440A00ULL, 0x4800404002011C00ULL,
    0x0104442040404200ULL, 0x0511080202091021ULL, 0x0004022401120400ULL, 0x80C0040400080120ULL,
    0x8040010040820802ULL, 0x0480810700020090ULL, 0x0102008E00040242ULL, 0x0809005202050100ULL,
    0x8002024220104080ULL, 0x0431008804142000ULL, 0x0019001802081400ULL, 0x0200014208040080ULL,
    0x3308082008200100ULL, 0x041010500040C020ULL, 0x4012020C04210308ULL, 0x208220A202004080ULL,
    0x0111040120082000ULL, 0x6803040141280A00ULL, 0x2101004202410000ULL, 0x8200000041108022ULL,
    0x0000021082088000ULL, 0x0002410204010040ULL, 0x0040100400809000ULL, 0x0822088220820214ULL,
    0x0040808090012004ULL, 0x00910224040218C9ULL, 0x0402814422015008ULL, 0x0090014004842410ULL,
    0x0001000042304105ULL, 0x0010008830412A00ULL, 0x2520081090008908ULL, 0x40102000A0A60140ULL,
};

Bitboard bishop_table[64][1 << 9];
Bitboard rook_table[64][1 << 12];

Bitboard square_bb[64];

// There now here comes the fun part
int HashBishop (Square square, Bitboard blockers) {
    return ((blockers & bishop_mask[square]) * bishop_magic[square]) >> (64 - bishop_relevancy[square]);
}

int HashRook (Square square, Bitboard blockers) {
    return ((blockers & rook_mask[square]) * rook_magic[square]) >> (64 - rook_relevancy[square]);
}

Bitboard RaycastBishop (Square square, Bitboard blockers) {

    Bitboard mask = 0ULL;

    int rank = square >> 3;
    int file = square & 7;

        

    for (int newRank = rank + 1, newFile = file + 1; newRank <= 7 && newFile <= 7; ++newRank, ++newFile) {

        Bitboard newSquareMask = 1ULL << (newRank << 3 | newFile);

        if ((newSquareMask & blockers) != 0ULL) {
            mask |= newSquareMask;
            break;
        }
        mask |= newSquareMask;
    }

    for (int newRank = rank + 1, newFile = file - 1; newRank <= 7 && newFile >= 0; ++newRank, --newFile) {
            
        Bitboard newSquareMask = 1ULL << (newRank << 3 | newFile);

        if ((newSquareMask & blockers) != 0ULL) {
            mask |= newSquareMask;
            break;
        }
        mask |= newSquareMask;
    }

    for (int newRank = rank - 1, newFile = file + 1; newRank >= 0 && newFile <= 7; --newRank, ++newFile) {
            
        Bitboard newSquareMask = 1ULL << (newRank << 3 | newFile);

        if ((newSquareMask & blockers) != 0ULL) {
            mask |= newSquareMask;
            break;
        }
        mask |= newSquareMask;
    }

    for (int newRank = rank - 1, newFile = file - 1; newRank >= 0 && newFile >= 0; --newRank, --newFile) {
            
        Bitboard newSquareMask = 1ULL << (newRank << 3 | newFile);

        if ((newSquareMask & blockers) != 0ULL) {
            mask |= newSquareMask;
            break;
        }
        mask |= newSquareMask;
    }

    return mask;
        
}

Bitboard RaycastRook (Square square, Bitboard blockers) {
    int rank = square >> 3;
    int file = square & 7;

    Bitboard mask = 0ULL;

    // North
    for (int newRank = rank + 1; newRank <= 7; ++newRank) {
        Bitboard newSquareMask = 1ULL << (newRank << 3 | file);

        if ((newSquareMask & blockers) != 0ULL) {
            mask |= newSquareMask;
            break;
        }
        mask |= newSquareMask;
    }

    // South
    for (int newRank = rank - 1; newRank >= 0; --newRank) {
        Bitboard newSquareMask = 1ULL << (newRank << 3 | file);

        if ((newSquareMask & blockers) != 0ULL) {
            mask |= newSquareMask;
            break;
        }
        mask |= newSquareMask;
    }

    // East 
    for (int newFile = file + 1; newFile <= 7; ++newFile) {
        Bitboard newSquareMask = 1ULL << (rank << 3 | newFile);

        if ((newSquareMask & blockers) != 0ULL) {
            mask |= newSquareMask;
            break;
        }
        mask |= newSquareMask;
    }

    // West
    for (int newFile = file - 1; newFile >= 0; --newFile) {
        Bitboard newSquareMask = 1ULL << (rank << 3 | newFile);

        if ((newSquareMask & blockers) != 0ULL) {
            mask |= newSquareMask;
            break;
        }
        mask |= newSquareMask;
    
    }

    return mask;
    
}

Bitboard GenerateBlocker (int index, Bitboard mask) {
    Bitboard blockers = 0ULL;

    int bit_num = 0;

    while (mask) {
        int square = ctz(mask);

        if (index & (1 << bit_num)) {
            blockers |= 1ULL << square;
        }

        mask &= mask - 1;
        ++bit_num;
    }

    return blockers;
}

void PrecomputeBishop (Square square) {
    for (int i = 0; i < (1 << bishop_relevancy[square]); i++) {
        
        Bitboard blockers = GenerateBlocker(i, bishop_mask[square]);

        Bitboard attacks = RaycastBishop(square, blockers);

        bishop_table[square][HashBishop(square, blockers)] = attacks;
    }
}

    

void PrecomputeRook (Square square) {
    for (int i = 0; i < (1 << rook_relevancy[square]); i++) {
        
        Bitboard blockers = GenerateBlocker(i, rook_mask[square]);

        Bitboard attacks = RaycastRook(square, blockers);

        rook_table[square][HashRook(square, blockers)] = attacks;
    }
}


} // anonymous namespace


namespace Eyra::Bitboards {



void Init() {
    for (Square square = A1; square < 64; ++square) {
        PrecomputeBishop(square);
        PrecomputeRook(square);

        // std::cout << "0x" << std::hex << std::uppercase << std::setw(16) << std::setfill('0') << ComputeRookMask(square) << "ULL," << (((square + 1) % 4 == 0) ? "\n" : "" );
        
        square_bb[square] = 1ULL << square;
    }
    
}

Bitboard SquareBB (Square square) {
    return square_bb[square];
}

Bitboard GetRookAttacks (Square square, Bitboard occupancy) {
    return rook_table[square][HashRook(square, occupancy)];
}

Bitboard GetBishopAttacks (Square square, Bitboard occupancy) {
    return bishop_table[square][HashBishop(square, occupancy)];
}

template <Color c>
Bitboard GetPawnAttacks (Square square) {
    return pawn_table[c][square];
}

Bitboard GetKnightAttacks (Square square) {
    return knight_table[square];
}

Bitboard GetKingAttacks (Square square) {
    return king_table[square];
}


template Bitboard GetPawnAttacks<WHITE>(Square);
template Bitboard GetPawnAttacks<BLACK>(Square);
} // namespace Eyra::Bitboards

